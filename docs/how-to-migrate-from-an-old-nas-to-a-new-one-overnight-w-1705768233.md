# 如何使用 rsync 在一夜之间从旧 NAS 迁移到新 NAS

> 原文：<https://lifehacker.com/how-to-migrate-from-an-old-nas-to-a-new-one-overnight-w-1705768233>

NAS 或网络连接存储设备非常适合存储您可以从家中任何一台计算机访问的文件。但是当你升级到一个新的硬盘时，你不得不手动拷贝所有的内容，交换硬盘，并且冒着数据丢失的风险。这里有一个更可靠的方法。



不久前，我买了一个全新的 NAS，它的空间比我的旧 NAS 大得多。这很棒，但是当我设置好它后，我就陷入了将万亿字节的数据从转移到新的 n as 的任务中。我不想物理移动驱动器，因为旧的驱动器比新的小。因为我是从一个 Synology NAS 迁移到另一个 Synology NAS，所以我可以使用他们的迁移工具，你是对的，但是如果我是从 Synology 迁移到 ReadyNAS，或者从 FreeNAS 迁移到 Synology，我就没有这个选项了。我想要一个平台无关的方法。在考虑了十几种完成这项工作的方法之后，我选定了我们最喜欢的一个命令行: [rsync](http://en.wikipedia.org/wiki/Rsync) 。

### 为什么 rsync 是文件传输工作的最佳工具

我现在能听到你说:“为什么要用命令行呢？我可以用[X 方法]做同样的事情，“你是对的！有很多方法可以完成这项工作，但是 rsync 有一些明显的优势，不仅仅是在你的电脑上打开一对窗口，把文件从一个拖到另一个。以下是几个大问题:

*   rsync 可能已经在您的 NAS 上。无论你的 NAS 是 [一个装满驱动器的现成机箱](http://lifehacker.com/five-best-nas-enclosures-5968677) 还是 [一个运行你偏好的操作系统](http://lifehacker.com/what-operating-system-should-i-use-for-my-diy-home-serv-1671385076) 的 DIY 模型，很可能它运行的是 linux 的一个变种。这意味着已经安装了命令行和 rsync。当然，如果您从一个品牌的 NAS 迁移到另一个相同品牌的 NAS，可能会有内置应用程序提供帮助，但 rsync 的美妙之处在于它可以在任何地方工作，不管是什么品牌，也不管驱动器或卷有多大。
*   **rsync 保留元数据**。这意味着文件所有权、原始创建日期、修改日期、文件权限等等，当您的副本到达新的目的地时，所有这些都会保留下来。尽管有新系统上的用户和权限，如果你不想让你的所有文件获得全新的创建日期，生成新的缩略图，或者像修订历史这样的事情对你很重要，这是一个确保信息得到保留的好方法。
*   **rsync 省去了中间人**。当你用个人电脑把文件从一个系统复制到另一个系统时，你的电脑就充当了两个系统之间的中间人。这就造成了传输中的另一个失败点，更不用说让您的主计算机不必要地忙碌了。如果你曾经在 Windows 中做过长时间的多文件复制操作，你至少知道这可能是令人讨厌的，即使是最小的事情也会使复制变得一团糟。当出现这种情况时，您将不得不努力找出复制失败的地方、原因以及从哪里重新开始。由于 rsync 是一种设备到设备的复制，所以无论您的计算机是否打开，它都会运行。
*   rsync 支持恢复传输、差分和同步。如果由于某种原因，您的传输中断了，比如反常的断电、系统错误或任何其他问题，rsync 能够从您中断的地方继续运行，不会出现问题。类似地，由于 rsync 被设计为同步目录(并使它们保持同步)，如果您需要使旧 NAS 与新 NAS 保持同步，或者您不小心将应该在新 NAS 上的新文件放在旧 NAS 上，rsync 可以为您移动它们，并且在此过程中将只接触已更改的或新的文件。
*   rsync 最小化网络开销。如果您在一夜之间完成这项工作，这可能对您来说无关紧要——您可能应该这样做——但是 rsync 最大的优点之一是它不会像其他工具那样带来相同的网络负载。这意味着您的其他备份或下载不会因为您正在使用它而变慢，并且您网络上的其他人可能根本不会注意到正在发生的任何事情。

正如我们提到的，rsync 是为同步文件而设计的，不仅仅是复制它们。我们之前已经向你展示了如何用它来镜像系统 ，以及 [如何将 iTunes 与任何 USB 设备](http://lifehacker.com/middleman-syncs-virtually-any-device-with-itunes-on-a-m-5501992) 同步，但它也只对直接的机器到机器拷贝有用，因为它非常灵活。它甚至可以给你一个方便的进度条，让你可以确保一切顺利进行。

### 第一步:启用远程访问并选择您的传输方法

rsync 的另一个好处是它只是一个命令行。你不能只打开一个终端窗口就开始拷贝——你需要做一些初始设置。

首先，您需要确保在两台旧的 NASes 上启用了 SSH 访问。SSH 允许您使用安全的 shell 从命令行登录到 NAS。在我的 Synology NAS 上，这就在控制面板下面，标着“终端和 SNMP”您可能会在 NAS 上的类似位置找到它，但它通常在“系统”、“远程访问”或“远程管理”的任何其他同义词下

一旦在两个 NASes 上启用了远程访问，并且拥有了两个系统的 admin(或 root)凭证，就可以开始了。现在，我们已经准备好登录旧的 NAS，并将我们的文件推送到新的 NAS。

### 如何使用 rsync 传输文件

现在该谈正事了。使用你最喜欢的 SSH 工具(在 Linux 或 OS X，你可以打开一个终端窗口，在 Windows 我喜欢用 [PuTTY](http://www.chiark.greenend.org.uk/~sgtatham/putty/) 来登录你的旧 NAS。在 OS X 或 Linux 中，只需打开一个终端窗口并键入以下内容:

`slogin admin@[IP ADDRESS OF YOUR OLD NAS]`

系统会提示您登录，一旦您登录，就会转到一个代表您的 NAS 的新命令行。在 Windows 中，打开 PuTTY。在主机名字段中，键入旧 NAS 的 IP 地址，确保选择了 SSH，然后单击打开。系统会提示您输入用户名(管理员或 root)和密码。登录后，您将进入 NAS 的命令行。

现在是运行 rsync 的时候了。语法非常简单。您需要用一个命令告诉 rsync 如何登录到远程设备，以及将文件放在哪里。方法如下:

`rsync -azP [SOURCE DIRECTORY] admin@[IP ADDRESS OF YOUR NEW NAS]:[SOURCE DIRECTORY]`

假设我在旧 NAS 上有一个名为“旧电影”的文件夹，在新 NAS 上有一个名为“新电影”的文件夹要将“旧电影”中的所有内容复制到“新电影”，该命令如下所示:

`rsync -azP old_movies/ admin@192.168.1.X:new_movies`

其中 192.168.1.X 是新 NAS 的 IP 地址。一旦运行了这个命令，就会提示您验证新 NAS 的 SSH 密钥是否正确，以及您是否希望存储它以供将来使用。第一次连接时，您可能会收到关于密钥的警告，但这没关系。键入“是”继续。系统将提示您使用管理员密码登录新的 NAS。继续做那件事。如果其他一切都成功了，只要你这样做，你的文件同步将开始。

在我们继续之前，让我们先来讨论一下那些标志——您在上面的命令中看到的“ *-azP* ”。它们很重要，原因如下:

*   **这里的“-a”标志**代表“存档”，包含它很重要。它确保 sync 命令是递归的(意味着 old_movies 中的任何子文件夹和文件也被复制),并且对于保留所有这些修改日期、符号链接、权限和我们前面讨论过的其他内容非常重要。
*   “-P”标志将另外两个有用的标志合并成一个，您将会用到它。它结合了“进度”和“部分”标志，当使用时，您会在命令行中看到一个进度对话框，显示当前正在传输哪个文件，传输完成的百分比，以及还有多少文件需要检查。随着每个文件的完成，您会看到一个不断增长的已完成文件传输的列表，这对于确保一切传输成功非常重要。它还允许您轻松恢复暂停或中断的传输。结合起来，您可以看到它如何向您显示哪个文件是最后一个要删除的，它在哪里失败了，如果它失败了，您可以选择继续。这是一个非常强大的组合。
*   “-z”标志是一个方便的 rsync 工具，它在传输文件时压缩文件，这给你带来了我们讨论过的“轻带宽”的好处。如果文件已经被压缩，你不会得到太多的好处，但如果他们不是，这将完成工作，而不会减慢你的家庭网络的其余部分。

您应该在复制之前仔细检查您的命令，以确保您复制到正确的目录和目录结构。

当需要迁移整个 NAS 时，您可以一个目录一个目录地进行，或者像我一样，一夜之间完成。做一个小的目录作为测试，以确保你的语法是正确的，当它起作用时，移动到父目录，一次复制全部内容。这将需要很长时间，但当您完成后，您的新 NAS 将设置为与旧 NAS 完全一样，一切就绪。

如果您是一个坚持不懈的人，并且喜欢粒度控制，请在新的 NAS 上创建您的目录和共享，然后将每个目录的内容从旧的 NAS 复制到新的 NAS 上。这样，您已经创建了目录，并使用 NAS 的界面授予了它们权限，其中的文件将保留它们所拥有的任何权限。

### 疑难解答问题、更新目录和附加阅读

如果您在拷贝方面遇到问题，或者遇到其他奇怪、古怪的问题，请在谷歌上搜索您的错误信息以及旧的或新的 NAS 的操作系统。你会惊讶地发现，有多少人和你有同样的问题。在我的例子中，当我迁移 Synology NAS 时，当我试图推或拉文件时，我遇到了一些奇怪的“rsync 服务没有运行”错误，结果发现我需要确保 Synology 的“网络备份服务”和“网络目的地服务”在源和目的地 NAS 上都启用了——这两个复选框深埋在控制面板中“信息中心”的服务选项卡上。我还必须确保以 root 用户身份登录——以管理员身份登录不会有问题。幸运的是， [Stefan 用这个有用的帖子](https://sejh.wordpress.com/2014/11/12/synology-network-backup-failing-with-rsync-error/) 拯救了我。

同样，如果你想了解 rsync 的来龙去脉，以便在系统间移动文件，贾斯汀·埃林伍德在 DigitalOcean 的社区论坛上的 rsync 漫游 非常有帮助，它帮助我确定了最好的标志，以及何时使用和何时不使用尾部斜线。如果您不小心写入旧的 NAS 而不是新的 NAS，并且需要运行差异同步，也就是说，使用 rsync 仅复制自上次同步以来已更改或不同的文件，他也有如何执行该操作的说明。如果你是 rsync 的老用户， [这个 How-to Geek](http://www.howtogeek.com/175008/the-non-beginners-guide-to-syncing-data-with-rsync/) 的演练将帮助你把这些技能提升到一个新的水平。

一旦您迁移了所有文件，您就可以对旧的 NAS 做任何您想做的事情了。把它变成 [一个下载盒](https://lifehacker.com/turn-an-old-computer-into-a-networked-backup-streaming-5822590) ，一个 [家庭影院系统](http://lifehacker.com/create-a-kickass-seamless-play-everything-media-cente-5900626) ， [用它来装不重要的文件或者备份](http://lifehacker.com/turn-an-old-computer-into-a-do-anything-home-server-wit-510023147) ，随便你。如果你打算卖掉或处理掉它，确保你事先 [正确擦拭并清理干净](http://lifehacker.com/what-should-i-do-to-my-computer-before-i-sell-it-5966580) 。运气好的话，可以换点现金。

<small>*标题照片制作使用*</small> [<small>*杜布罗文*</small>](http://www.shutterstock.com/pic-204596788/stock-vector-big-data-servers-and-hardware.html?src=q7Q7tI-kbBPBy4lHoRoAhw-1-1) <small>*。*T15】</small>

[Open *kinja-labs.com*](http://kinja-labs.com/related-widget/?posts=1516484110,1678991505,510023147&title=More NAStastic Stories)